<!DOCTYPE html>
<html>
<head>
<style>
#map{
	height: 100%;
	width: 100%;
}
</style>	
<script src="../lib/closure-library/closure/goog/base.js"></script>
<script src="../lib/jquery.min.js"></script>
<script src="../lib/ol-whitespace.js"></script> 
<script>
goog.require('goog.net.XhrIo');
goog.require('goog.events');
goog.require('goog.array');
</script>
</head>
<body>
<div id="map"></div>
<script type="text/javascript">
	var loadFeatures = function(response) {
		vectorSource.clear();
		
		console.log('Try to add ' +  response.length + ' features.');
		for (var i = 0; i < response.length; i++){
			vectorSource.addFeature(response[i]);
		};
	  	//vectorSource.addFeatures(vectorSource.readFeatures(response));
	};

	var config = {
            'featureNS': 'http://mapserver.gis.umn.edu/mapserver',
            'featureType': 'Historische_Messtischblaetter_WFS'
    };
	
	var vectorSource = new ol.source.ServerVector({
	  format: new ol.format.WFS(config),
	  loader: function(extent, resolution, projection) {
	    var url = 'http://localhost:8080/vkviewer/proxy/?url=http://194.95.145.43/cgi-bin/mtbows?SERVICE=WFS&' +
	    	'VERSION=1.1.0&REQUEST=getfeature&TYPENAME=Historische_Messtischblaetter_WFS&MAXFEATURES=10000&srsname=EPSG:900913&' +
	    	'bbox=' + extent.join(',');
	    
	    var xhr = new goog.net.XhrIo();
	    
	    goog.events.listenOnce(xhr, 'success', function(e){
	    	var xhr = /** @type {goog.net.XhrIo} */ (e.target);
	    	var data = xhr.getResponseXml() ? xhr.getResponseXml() : xhr.getResponseText();
	    	xhr.dispose();
	    	loadFeatures((data));
	    }, false, this);

	    xhr.send(url);
	  },
	  projection: 'EPSG:900913'
	});

	var vector = new ol.layer.Vector({
	  source: vectorSource,
	  style: function(feature, resolution){
		  if (feature.get('time') == 1912){		  
			  return [new ol.style.Style({
			    stroke: new ol.style.Stroke({
			      color: 'rgba(0, 0, 255, 1.0)',
			      width: 2
			    })
			  })]
		  } else { return undefined};
	  }
	});

	var raster = new ol.layer.Tile({
	  source: new ol.source.BingMaps({
	    imagerySet: 'Aerial',
	    key: 'Ak-dzM4wZjSqTlzveKz5u0d4IQ4bRzVI309GxmkgSVr1ewS6iPSrOvOKhA-CJlm3'
	  })
	});

	var map = new ol.Map({
	  layers: [raster, vector],
	  target: document.getElementById('map'),
	  view: new ol.View2D({
	    center: [1528150, 6630500],
	    maxZoom: 19,
	    zoom: 12
	  })
	});

	
</script>

</body>
</html>

